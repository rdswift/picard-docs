name: Manual Check and Basic Build (Test)

on:
  workflow_dispatch:

jobs:
  lint_rst_and_basic_build:
    name: Check with LintRST and Basic Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.7]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Lint Test RST Files
      run: python ./setup.py test rst
    - name: Setup for Build
      run: |
        export SPHINXBUILD=`which sphinx-build`
        mkdir _build
        mkdir docs
    - name: Build Tag Map Files
      run: |
        python ./setup.py build map
    - name: Store Tag Map Build Output File
      uses: actions/upload-artifact@v2
      with:
        name: tag_map_files
        path: docs/MusicBrainz_Picard_Tag_Map.*
        retention-days: 5
    - name: Build HTML Files
      run: |
        python ./setup.py clean html
        python ./setup.py build html
    - name: Store HTML Build Output File
      uses: actions/upload-artifact@v2
      with:
        name: html_files
        path: docs/*.zip
        retention-days: 5
    - name: Build EPUB File
      run: |
        python ./setup.py clean epub
        python ./setup.py build epub
    - name: Store ePub Build Output File
      uses: actions/upload-artifact@v2
      with:
        name: epub_file
        path: docs/*.epub
        retention-days: 5
    - name: Build latex File
      run: |
        python ./setup.py clean latex
        python ./setup.py build latex
    - name: Store latex Build Output File
      uses: actions/upload-artifact@v2
      with:
        name: latex_files
        path: _build/latex/*
        retention-days: 5
    - name: Build PDF File
      uses: dante-ev/latex-action@latest
      with:
        working_directory: _build/latex
        root_file: musicbrainzpicard.tex
    - name: Store PDF Build Output File
      uses: actions/upload-artifact@v2
      with:
        name: pdf_file
        path: _build/*.pdf
        retention-days: 5
    - name: Display Variables Passed to Publish Action
      run: |
        cat docs/__init__.py
